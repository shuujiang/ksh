function featureSet(e){e.staticOption.show?($(".branches1").show(),$(".branches1 .order option[value="+e.staticOption.dataArticle.order+"]").attr("selected",!0),$(".branches1 .num").val(e.staticOption.dataArticle.num)):($(".branches1").hide(),$(".branches1 .order option[value="+e.staticOption.dataArticle.order+"]").attr("selected",!1),$(".branches1 .num").val(""))}function _eachEcharts(e,i){function t(e){$(".biao").children().remove(),d=getDataFromAjax(ctx+"/qd/qdDimMeasureFields/getTable",{qdDatasourceId:e,type:$(".yuan option:selected").attr("type")}),a=!1,d.forEach(function(e,i){var t;t=""==e.name?e.id:e.name;var n=$("<option name='biao"+(i+1)+"'>"+t+"</option>").appendTo($(".biao"));n.val(e.id),e.id==olDoption.tableId&&(n.attr("selected","selected"),o(e.id),a=!0),a||d.length-1!=i||(o(e.id),a=!0)})}function o(e){wds=getDataFromAjax(ctx+"//qd/qdDimMeasureFields/getWD",{qdDatasourceId:$(".yuan").val(),tableId:$(".biao").val(),type:$(".yuan option:selected").attr("type")}),wds.forEach(function(e,i){if("1"==e.type){var t=$("<div ></div>").addClass("Xvariate variate").appendTo(".x-variable");t.text(e.name),t.attr("name",e.id)}else{var o=$("<div ></div>").addClass("Yvariate variate").appendTo(".y-variable");o.text(e.name),o.attr("name",e.id)}}),weiduX(),duliangY(),n=!0}var a=!1,n=!1;dims=""==olDoption.dims||null==olDoption.dims?new Array:olDoption.dims.split(","),measures=null!=olDoption.measures&&""!=olDoption.measures?olDoption.measures.split(","):new Array,$(".yuan").children().remove();var s=getDataFromAjax(ctx+"/qd/qdDimMeasureFields/source");s.forEach(function(e,i){var o=$("<option name='yuan"+(i+1)+"'>"+e.name+"</option>").appendTo($(".yuan"));o.val(e.id),o.attr("type",e.type),e.id==olDoption.dbsrcId&&(o.attr("selected","selected"),t(e.id))}),a||t(s[0].id),$(".yuan").change(function(){var e=$(this).val();dims=[],measures=[],$(".x-variable").children().remove(),$(".y-variable").children().remove(),$(".X_variable").children().remove(),$(".Y_variable").children().remove(),$(".biao").children().remove(),$(".aBox").children().remove();$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dataOption={},Dlen=dims.length,Mlen=measures.length,t(e)});var d;$(".biao").change(function(){var e=$(this).val();dims=[],measures=[],$(".x-variable").children().remove(),$(".y-variable").children().remove(),$(".X_variable").children().remove(),$(".Y_variable").children().remove(),$(".aBox").children().remove();$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dataOption={},Dlen=dims.length,Mlen=measures.length,o(e)}),!n&&d[0]&&o(d[0].id),dims.forEach(function(e){for(index in wds)if(wds[index].id==e){var i=$("<div ></div>").addClass("Xvariate variate").appendTo(".X_variable");i.text(wds[index].name),i.attr("name",wds[index].id)}}),measures.forEach(function(e){for(index in wds)if(wds[index].id==e){var i=$("<div ></div>").addClass("Yvariate variate").appendTo(".Y_variable");i.text(wds[index].name),i.attr("name",wds[index].id)}}),weiduX(),duliangY(),Dlen=dims.length,Mlen=measures.length,wddl(e,i)}function weiduX(){$(".Xvariate").bind("mousedown",function(e){e.preventDefault&&e.preventDefault(),oDiv=$(this).parent().parent().attr("class"),$(".clone").length&&$(".clone").remove(),thisDom=$(this),$(this).clone().addClass("clone").appendTo($("body")),$("body").css("cursor","move"),$(".clone").css("left",e.clientX+10),$(".clone").css("top",e.clientY-15)})}function duliangY(){$(".Yvariate").bind("mousedown",function(e){e.preventDefault&&e.preventDefault(),oDiv=$(this).parent().parent().attr("class"),$(".clone").length&&$(".clone").remove(),thisDom=$(this),$(this).clone().addClass("clone").appendTo($("body")),$("body").css("cursor","move"),$(".clone").css("left",e.clientX+10),$(".clone").css("top",e.clientY-15)})}function wddl(e,i){function t(i){if(i.preventDefault&&i.preventDefault(),"x-dimension dimension"==oDiv||"y-dimension dimension"==oDiv){var t=thisDom.attr("name");dims.forEach(function(e,i){e==t&&dims.baoremove(i)}),measures.forEach(function(e,i){e==t&&measures.baoremove(i)}),thisDom.remove(),olDoption.dataOption={},olDoption.dims=dims.join(),olDoption.measures=measures.join(),n=measures.length,a=dims.length,$(".aBox").children().remove();var d=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));"much-much"==s?0!=n&&0!=a&&o(olDoption,e,d,s):"one-much"==s?n>0&&a>0&&o(olDoption,e,d,s):"much-two"==s?2==n&&o(olDoption,e,d,s):"two-FourSix"==s&&n>3&&o(olDoption,e,d,s),Dlen=a,weiduX(),Mlen=n,duliangY(),oDiv=null}}function o(e,i,t,o){var a=e.type,n={};n.designId=getQueryString("id",window.location.href),n.dbsrcId=$(".yuan").val(),n.sourceType=$(".yuan option:selected").attr("type"),n.tableId=$(".biao").val(),n.dims=dims.join(),n.measures=measures.join(),n.chartType=e.chartType,n.chartName=e.staticOption.staticType,n.type=a,n.field=stringifyMore(wds);var s=getDataFromAjax(ctx+"//qd/qdDesign/getDataoption",{qdDesignChildren:stringifyMore(n)});if("echarts"==a||"echarts2"==a){var d=stringifyMore(e.staticOption.chartOption.series[0]),r=[];if("one-much"==o&&s.series.length>0&&(s.series.forEach(function(){r.push(parseMore(d))}),e.staticOption.chartOption.series=r),"bar"==e.staticOption.staticOption){var l=copyAndClear(s.xAxis);s.xAxis=s.yAxis,s.yAxis=l}if("GIS"==e.chartType){var c=s.series.length,h=0,p=0;s.series.forEach(function(e){h+=e[0],p+=e[1]}),e.staticOption.chartOption.center.lng=(h/c).toFixed(6),e.staticOption.chartOption.center.lat=(p/c).toFixed(6)}e.dataOption=s,t.children().remove(),TBSC(e,i,t)}else e.dataOption=s,countUpFun(e,"_echart",t)}var a,n,s=olDoption.staticOption.wdType;$(document).mousemove(function(e){$(".clone").length>0&&($(".clone").css("left",e.clientX+10),$(".clone").css("top",e.clientY-15))}),$(document).mouseup(function(e){$(".clone").remove(),$("body").css("cursor","auto")}),$(".X_variable").bind("mouseup",function(i){if(i.preventDefault&&i.preventDefault(),"dimension_x"==oDiv){var t=thisDom.attr("name");"much-much"==s?wds.forEach(function(i){if(i.id==t){var n=i.id,d=!0;if(dims.forEach(function(e){e==t&&(d=!1)}),d){dims.push(n),$(".clone").appendTo($(".X_variable")),$(".clone").removeClass("clone"),a=dims.length,$(".aBox").children().remove();var r=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dims=dims.join(),olDoption.dataOption={},o(olDoption,e,r,s)}}}):"one-much"==s?0==Dlen&&wds.forEach(function(i){if(i.id==t){var n=i.id;dims.push(n),$(".clone").appendTo($(".X_variable")),$(".clone").removeClass("clone"),a=dims.length,$(".aBox").children().remove();var d=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dims=dims.join(),olDoption.dataOption={},Mlen>0&&a>0&&o(olDoption,e,d,s)}}):"two-FourSix"==s?Dlen<3&&wds.forEach(function(i){if(i.id==t){var n=i.id,d=!0;if(dims.forEach(function(e){e==t&&(d=!1)}),d){console.log(592,dims),dims.push(n),$(".clone").appendTo($(".X_variable")),$(".clone").removeClass("clone"),a=dims.length,$(".aBox").children().remove();var r=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dims=dims.join(),olDoption.dataOption={},Mlen>3&&o(olDoption,e,r,s)}}}):"one-two"==s?0==Dlen&&wds.forEach(function(i){if(i.id==t){var n=i.id;dims.push(n),$(".clone").appendTo($(".X_variable")),$(".clone").removeClass("clone"),a=dims.length,$(".aBox").children().remove();var d=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dims=dims.join(),olDoption.dataOption={},2==Mlen&&o(olDoption,e,d,s)}}):"one-one"==s?0==Dlen&&wds.forEach(function(i){if(i.id==t){var n=i.id;dims.push(n),$(".clone").appendTo($(".X_variable")),$(".clone").removeClass("clone"),a=dims.length,$(".aBox").children().remove();var d=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dims=dims.join(),olDoption.dataOption={},1==Mlen&&o(olDoption,e,d,s)}}):"two-not"==s?Dlen<2&&wds.forEach(function(i){if(i.id==t){var n=i.id,d=!0;if(dims.forEach(function(e){e==t&&(d=!1)}),d){dims.push(n),$(".clone").appendTo($(".X_variable")),$(".clone").removeClass("clone"),a=dims.length,$(".aBox").children().remove();var r=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dims=dims.join(),olDoption.dataOption={},2==a&&o(olDoption,e,r,s)}}}):"much-two"==s&&wds.forEach(function(i){if(i.id==t){var n=i.id;dims.push(n),$(".clone").appendTo($(".X_variable")),$(".clone").removeClass("clone"),a=dims.length,$(".aBox").children().remove();var d=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.dims=dims.join(),olDoption.dataOption={},2==Mlen&&o(olDoption,e,d,s)}}),Dlen=a,xDiv=null,weiduX()}}),$(".Y_variable").bind("mouseup",function(i){if(i.preventDefault&&i.preventDefault(),"dimension_y"==oDiv){var t=thisDom.attr("name");"much-much"==s?wds.forEach(function(i){if(i.id==t){var a=i.id,d=!0;if(measures.forEach(function(e){e==t&&(d=!1)}),d){measures.push(a),$(".clone").appendTo($(".Y_variable")),$(".clone").removeClass("clone"),$(".aBox").children().remove();var r=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));n=measures.length,olDoption.measures=measures.join(),olDoption.dataOption={},o(olDoption,e,r,s)}}}):"one-much"==s?wds.forEach(function(i){if(i.id==t){var a=i.id,d=!0;if(measures.forEach(function(e){e==t&&(d=!1)}),d){measures.push(a),$(".clone").appendTo($(".Y_variable")),$(".clone").removeClass("clone"),$(".aBox").children().remove();var r=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));n=measures.length,olDoption.measures=measures.join(),olDoption.dataOption={},Dlen>0&&n>0&&o(olDoption,e,r,s)}}}):"two-FourSix"==s?Mlen<6&&(console.log(752),wds.forEach(function(i){if(i.id==t){var a=i.id,d=!0;if(measures.forEach(function(e){e==t&&(d=!1)}),d){measures.push(a),$(".clone").appendTo($(".Y_variable")),$(".clone").removeClass("clone"),n=measures.length,$(".aBox").children().remove();var r=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.measures=measures.join(),olDoption.dataOption={},n>3&&o(olDoption,e,r,s)}}})):"one-two"==s?Mlen<2&&wds.forEach(function(i){if(i.id==t){var a=i.id,d=!0;if(measures.forEach(function(e){e==t&&(d=!1)}),d){measures.push(a),$(".clone").appendTo($(".Y_variable")),$(".clone").removeClass("clone"),n=measures.length,$(".aBox").children().remove();var r=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.measures=measures.join(),olDoption.dataOption={},1==Dlen&&2==n&&o(olDoption,e,r,s)}}}):"one-one"==s?0==Mlen&&wds.forEach(function(i){if(i.id==t){var a=i.id;measures.push(a),$(".clone").appendTo($(".Y_variable")),$(".clone").removeClass("clone"),n=measures.length,$(".aBox").children().remove();var d=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.measures=measures.join(),olDoption.dataOption={},1==Dlen&&o(olDoption,e,d,s)}}):"not-one"==s?0==Mlen&&(console.log(780),wds.forEach(function(i){if(i.id==t){var a=i.id;measures.push(a),$(".clone").appendTo($(".Y_variable")),$(".clone").removeClass("clone"),n=measures.length,$(".aBox").children().remove();var d=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.measures=measures.join(),olDoption.dataOption={},0==Dlen&&o(olDoption,e,d,s)}})):"much-two"==s&&Mlen<2&&wds.forEach(function(i){if(i.id==t){var a=i.id,d=!0;if(measures.forEach(function(e){e==t&&(d=!1)}),d){measures.push(a),$(".clone").appendTo($(".Y_variable")),$(".clone").removeClass("clone"),n=measures.length,$(".aBox").children().remove();var r=$('<div class="element" id="_echart" style="width:100%;height:100%;"></div>').appendTo($(".aBox"));olDoption.measures=measures.join(),olDoption.dataOption={},2==n&&o(olDoption,e,r,s)}}}),Mlen=n,yDiv=null,duliangY()}}),$(".chartData_graph").bind("mouseup",function(e){t(e)}),$(".initial").bind("mouseup",function(e){t(e)}),$(".chartData-zuo").bind("mouseup",function(e){t(e)})}function createFound(){if(SXcsh={id:"",isNewRecord:!1,remarks:null,createDate:null,updateDate:null,designId:"",type:"select",dateType:"",absDefault:0,absValue:"",beginDate:"",endDate:"",name:"",nameId:"",tempValue1:"",tempValue2:"",filterOption:{},qdFilterChilrdenList:[]},canFilterFun(),chartList.length>0){bouncedHideFun(),$(".selectBox").show();var e=chartList[0].index,i={dbsrcId:allOptions[e].dbsrcId,tableId:allOptions[e].tableId,sourceType:allOptions[e].sourceType,measures:allOptions[e].measures,dims:allOptions[e].dims};qdt=getDataFromAjax(ctx+"/qd/test/getScreen",i);var t=shuzuBJ(chartList[0].wds[0].id,qdt);otherChartList=copyAndClear(chartList),otherChartList.splice(0,1),SXcsh.filterOption.componentId=chartList[0].id,SXcsh.filterOption.designId=getQueryString("id",window.location.href),SXcsh.filterOption.filterCondition=t,SXcsh.type=chartList[0].wds[0].fieldType,SXcsh.filterOption.wdId=chartList[0].wds[0].id,SXcsh.qdFilterChilrdenList[0].wdId=chartList[0].wds[0].id,canFilterFun(),initialeOption(0,"create")}else 0==allOptions.length?top.layer.alert("请添加图表！"):top.layer.alert("图表需要先配置数据源信息！")}function createInit(){bouncedHideFun(),$(".selectBox").show(),SXarr.forEach(function(e,i){e.nameId==sxID&&(allOptions.forEach(function(i,t){e.id==i.id&&(e.name=i.staticOption.title.name)}),SXcsh=e,canFilterFun(),chartList.forEach(function(e,i){SXcsh.filterOption.componentId==e.id&&(otherChartList=copyAndClear(chartList),otherChartList.splice(i,1),otherChartList.forEach(function(e,i){e.wdsId=SXcsh.qdFilterChilrdenList[i+1].wdId}),initialeOption(i,"editor"))}))})}function canFilterFun(){var e=0;chartList=[];var i=SXcsh.qdFilterChilrdenList.length;canvasArray.forEach(function(t,o){if(""!=allOptions[o].dims&&void 0!=allOptions[o].dims){wds=getDataFromAjax(ctx+"/qd/qdDimMeasureFields/getWD",{qdDatasourceId:allOptions[o].dbsrcId,tableId:allOptions[o].tableId,type:allOptions[o].sourceType});var a=[];wds.forEach(function(e,i){"1"==e.type&&a.push(e)});var n=getDataFromAjax(ctx+"/qd/qdDimMeasureFields/datasource",{datasourceId:allOptions[o].dbsrcId,type:allOptions[o].sourceType});0==i&&SXcsh.qdFilterChilrdenList.push({componentId:allOptions[o].id,type:"1",wdId:"",filterCondition:[],orderBy:e+++""});var s={id:allOptions[o].id,chartName:allOptions[o].chartName,datasource:n[0].name,wds:a,wdsId:"",index:o};chartList.push(s)}})}function initialeOption(e,i){var t=SXcsh.dateType;""==t&&(t="single");var o={shaixuanType:i,SXname:SXcsh.name,chartList:chartList,otherChartList:otherChartList,chartId:SXcsh.filterOption.componentId,wdsList:chartList[e].wds,wdsId:SXcsh.filterOption.wdId,fieldType:SXcsh.type,qdtList:SXcsh.filterOption.filterCondition,datasource:chartList[e].datasource,acquiescence:"",dateType:t,date:"",daterange:""};dateShowFun(),"date"==SXcsh.type?"range"==t?"dateTimePicker"==datePickerType||"datePicker"==datePickerType?o.daterange=[new Date(SXcsh.beginDate),new Date(SXcsh.endDate)]:o.daterange=[new Date("2017-01-01 "+SXcsh.beginDate),new Date("2017-01-01 "+SXcsh.endDate)]:"dateTimePicker"==datePickerType||"datePicker"==datePickerType?""!=SXcsh.absValue&&(o.date=new Date(SXcsh.absValue)):o.date=new Date("2017-01-01 "+SXcsh.absValue):o.acquiescence=SXcsh.absValue,selContent.initialValue(o)}function dateShowFun(){if("date"==SXcsh.type){$(".section4").removeClass("hidden"),$(".section3").addClass("hidden"),$("#datetime").hide(),$("#date").hide(),$("#timePicker").hide();var e=SXcsh.dateType,i=SXcsh.filterOption.filterCondition[0];i.indexOf("-")>-1&&i.indexOf(":")>-1?($("#datetime").show(),datePickerType="dateTimePicker",$("#datetimerange").hide(),$("#datetimesingle").hide(),"range"==e?$("#datetimerange").show():$("#datetimesingle").show()):i.indexOf("-")>-1?($("#date").show(),datePickerType="datePicker",$("#daterange").hide(),$("#datesingle").hide(),"range"==e?$("#daterange").show():$("#datesingle").show()):i.indexOf(":")>-1&&($("#timePicker").show(),datePickerType="timePicker",$("#timerange").hide(),$("#timesingle").hide(),"range"==e?$("#timerange").show():$("#timesingle").show()),SXcsh.remarks=datePickerType}else $(".section3").removeClass("hidden"),$(".section4").addClass("hidden")}var olDoption,wds,dims=[],measures=[],chartOption={},postOption={},Dlen,Mlen,thisDom,oDiv;$(document).on("ifChanged","#amount",function(){"checked"==$(this).attr("checked")?olDoption.staticOption.show=!0:olDoption.staticOption.show=!1,featureSet(olDoption)}),$(".order").change(function(){olDoption.staticOption.dataArticle.order=$(this).val()}),$(".num").change(function(){olDoption.staticOption.dataArticle.num=$(this).val()});var SXcsh={};$(document).on("click",".screening",function(){createFound()}),$(document).on("click",".shaixuanqi",function(){createInit()});